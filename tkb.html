<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sao Ch√©p N·ªôi Dung Trang T√≠nh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link rel="stylesheet" href="tkbStyles.css">
</head>
<body>
    <div class="container">
        <h1>üìã Sao Ch√©p N·ªôi Dung Trang T√≠nh</h1>
        
        <!-- <div class="info-box">
            <h3>üìù Ch·ª©c nƒÉng:</h3>
            <ul>
                <li>Sao ch√©p n·ªôi dung t·ª´ √¥ D4:E63 c·ªßa trang t√≠nh th·ª© 3</li>
                <li>D√°n v√†o t·∫•t c·∫£ c√°c trang t√≠nh sau n√≥ (t·ª´ trang t√≠nh th·ª© 4 tr·ªü ƒëi)</li>
                <li>Gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng c·ªßa file g·ªëc</li>
            </ul>
        </div> -->
        
        <form id="excelForm">
            <div class="form-group">
                <label for="inputFile">üìÅ Ch·ªçn file Excel (.xlsx):</label>
                <div class="file-input-wrapper">
                    <input type="file" id="inputFile" class="file-input" accept=".xlsx,.xls" required>
                    <label for="inputFile" class="file-input-label">
                        <span class="icon">üìÅ</span>
                        Ch·ªçn file Excel
                    </label>
                </div>
                <div class="file-name" id="inputFileName">Ch∆∞a ch·ªçn file</div>
            </div>

            <div class="form-group">
                <label for="outputName">üíæ T√™n file xu·∫•t ra:</label>
                <input type="text" id="outputName" placeholder="Nh·∫≠p t√™n file (kh√¥ng c·∫ßn ƒëu√¥i .xlsx)" value="" required>
            </div>

            <div class="form-group">
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="icon">üöÄ</span>
                    X·ª≠ L√Ω v√† T·∫£i File
                </button>
            </div>
        </form>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status" id="status"></div>
    </div>

    <script>
        // X·ª≠ l√Ω hi·ªÉn th·ªã t√™n file
        document.getElementById('inputFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Ch∆∞a ch·ªçn file';
            document.getElementById('inputFileName').textContent = fileName;
        });

        // X·ª≠ l√Ω form submit
        document.getElementById('excelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const inputFile = document.getElementById('inputFile').files[0];
            const outputName = document.getElementById('outputName').value.trim();
            
            if (!inputFile || !outputName) {
                showStatus('Vui l√≤ng ch·ªçn file v√† nh·∫≠p t√™n file xu·∫•t ra!', 'error');
                return;
            }

            try {
                showStatus('ƒêang x·ª≠ l√Ω file...', 'processing');
                showProgress(0);
                
                // ƒê·ªçc file Excel
                const workbook = await readExcelFile(inputFile);
                showProgress(30);
                
                // Ki·ªÉm tra s·ªë l∆∞·ª£ng trang t√≠nh
                if (workbook.worksheets.length < 3) {
                    throw new Error('File ph·∫£i c√≥ √≠t nh·∫•t 3 trang t√≠nh');
                }
                
                // Sao ch√©p n·ªôi dung
                await copySheetContent(workbook);
                showProgress(80);
                
                // T·∫°o v√† t·∫£i file
                await downloadExcelFile(workbook, outputName);
                showProgress(100);
                
                showStatus('‚úÖ X·ª≠ l√Ω ho√†n th√†nh! File ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng.', 'success');
                
            } catch (error) {
                console.error('L·ªói:', error);
                showStatus('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
            }
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'processing') {
                document.getElementById('progressBar').style.display = 'block';
            } else {
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
            }
        }

        function showProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // ƒê·ªçc file Excel v·ªõi ExcelJS
        async function readExcelFile(file) {
            const workbook = new ExcelJS.Workbook();
            const arrayBuffer = await file.arrayBuffer();
            await workbook.xlsx.load(arrayBuffer);
            return workbook;
        }

        // Sao ch√©p n·ªôi dung t·ª´ trang t√≠nh th·ª© 3 sang c√°c trang t√≠nh sau
        async function copySheetContent(workbook) {
            const sheets = workbook.worksheets;
            
            if (sheets.length < 3) {
                throw new Error('File ph·∫£i c√≥ √≠t nh·∫•t 3 trang t√≠nh');
            }
            
            // L·∫•y trang t√≠nh th·ª© 3 (index = 2)
            const sourceSheet = sheets[2];
            console.log(`Trang t√≠nh ngu·ªìn: ${sourceSheet.name}`);
            
            // L∆∞u tr·ªØ d·ªØ li·ªáu v√† ƒë·ªãnh d·∫°ng t·ª´ v√πng D4:E63
            const sourceData = [];
            
            // ƒê·ªçc d·ªØ li·ªáu t·ª´ D4 ƒë·∫øn E63 (60 d√≤ng)
            for (let row = 4; row <= 63; row++) {
                const rowData = {
                    colD: {
                        value: sourceSheet.getCell(`D${row}`).value,
                        style: Object.assign({}, sourceSheet.getCell(`D${row}`).style)
                    },
                    colE: {
                        value: sourceSheet.getCell(`E${row}`).value,
                        style: Object.assign({}, sourceSheet.getCell(`E${row}`).style)
                    }
                };
                sourceData.push(rowData);
            }
            
            console.log(`ƒê√£ ƒë·ªçc ${sourceData.length} d√≤ng t·ª´ trang t√≠nh ngu·ªìn`);
            
            // Sao ch√©p sang c√°c trang t√≠nh t·ª´ th·ª© 4 tr·ªü ƒëi
            let copiedSheets = 0;
            for (let i = 3; i < sheets.length; i++) {
                const targetSheet = sheets[i];
                console.log(`ƒêang sao ch√©p sang trang t√≠nh: ${targetSheet.name}`);
                
                // D√°n d·ªØ li·ªáu v√†o v√πng D4:E63
                for (let row = 0; row < sourceData.length; row++) {
                    const targetRow = row + 4; // B·∫Øt ƒë·∫ßu t·ª´ d√≤ng 4
                    
                    // Sao ch√©p c·ªôt D
                    const targetCellD = targetSheet.getCell(`D${targetRow}`);
                    targetCellD.value = sourceData[row].colD.value;
                    targetCellD.style = sourceData[row].colD.style;
                    
                    // Sao ch√©p c·ªôt E
                    const targetCellE = targetSheet.getCell(`E${targetRow}`);
                    targetCellE.value = sourceData[row].colE.value;
                    targetCellE.style = sourceData[row].colE.style;
                }
                
                copiedSheets++;
            }
            
            console.log(`ƒê√£ sao ch√©p th√†nh c√¥ng sang ${copiedSheets} trang t√≠nh`);
            
            // C·∫≠p nh·∫≠t progress
            showProgress(70);
            
            if (copiedSheets === 0) {
                throw new Error('Kh√¥ng c√≥ trang t√≠nh n√†o ƒë·ªÉ sao ch√©p (c·∫ßn √≠t nh·∫•t 4 trang t√≠nh)');
            }
        }

        // T·∫°o v√† t·∫£i file Excel
        async function downloadExcelFile(workbook, fileName) {
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.endsWith('.xlsx') ? fileName : fileName + '.xlsx';
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>