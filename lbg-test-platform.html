<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch B√°o Gi·∫£ng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>üéì L·ªãch B√°o Gi·∫£ng</h1>
        
        <form id="excelForm">
            <div class="form-group">
                <label for="lichBaoGiang">üìÖ Ch·ªçn file L·ªãch B√°o Gi·∫£ng (.xlsx):</label>
                <div class="file-input-wrapper">
                    <input type="file" id="lichBaoGiang" class="file-input" accept=".xlsx,.xls" required>
                    <label for="lichBaoGiang" class="file-input-label">
                        <span class="icon">üìÅ</span>
                        Ch·ªçn file L·ªãch B√°o Gi·∫£ng
                    </label>
                </div>
                <div class="file-name" id="lichBaoGiangName">Ch∆∞a ch·ªçn file</div>
            </div>

            <div class="form-group">
                <label for="noiDung">üìö Ch·ªçn file N·ªôi Dung (.xlsx):</label>
                <div class="file-input-wrapper">
                    <input type="file" id="noiDung" class="file-input" accept=".xlsx,.xls" required>
                    <label for="noiDung" class="file-input-label">
                        <span class="icon">üìÅ</span>
                        Ch·ªçn file N·ªôi Dung
                    </label>
                </div>
                <div class="file-name" id="noiDungName">Ch∆∞a ch·ªçn file</div>
            </div>

            <div class="form-group">
                <label for="outputName">üíæ T√™n file xu·∫•t ra:</label>
                <input type="text" id="outputName" placeholder="Nh·∫≠p t√™n file (kh√¥ng c·∫ßn ƒëu√¥i .xlsx)" value="" required>
            </div>

            <div class="form-group">
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="icon">‚ö°</span>
                    X·ª≠ L√Ω v√† T·∫£i File
                </button>
            </div>
        </form>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status" id="status"></div>
    </div>

    <script>
        // X·ª≠ l√Ω hi·ªÉn th·ªã t√™n file
        document.getElementById('lichBaoGiang').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Ch∆∞a ch·ªçn file';
            document.getElementById('lichBaoGiangName').textContent = fileName;
        });

        document.getElementById('noiDung').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Ch∆∞a ch·ªçn file';
            document.getElementById('noiDungName').textContent = fileName;
        });

        // X·ª≠ l√Ω form submit
        document.getElementById('excelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const lichBaoGiangFile = document.getElementById('lichBaoGiang').files[0];
            const noiDungFile = document.getElementById('noiDung').files[0];
            const outputName = document.getElementById('outputName').value.trim();
            
            if (!lichBaoGiangFile || !noiDungFile || !outputName) {
                showStatus('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß c√°c file v√† nh·∫≠p t√™n file xu·∫•t ra!', 'error');
                return;
            }

            try {
                showStatus('ƒêang x·ª≠ l√Ω file...', 'processing');
                showProgress(0);
                
                // ƒê·ªçc file n·ªôi dung
                const noiDungData = await readExcelFile(noiDungFile);
                showProgress(30);
                
                // ƒê·ªçc file l·ªãch b√°o gi·∫£ng  
                const lichBaoGiangWorkbook = await readExcelFileWithFormat(lichBaoGiangFile);
                showProgress(60);
                
                // X·ª≠ l√Ω d·ªØ li·ªáu - Logic gi·ªëng Python
                await processDataLikePython(noiDungData, lichBaoGiangWorkbook);
                showProgress(90);
                
                // T·∫°o v√† t·∫£i file
                await downloadExcelFile(lichBaoGiangWorkbook, outputName);
                showProgress(100);
                
                showStatus('‚úÖ X·ª≠ l√Ω ho√†n th√†nh! File ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng.', 'success');
                
            } catch (error) {
                console.error('L·ªói:', error);
                showStatus('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
            }
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'processing') {
                document.getElementById('progressBar').style.display = 'block';
            } else {
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
            }
        }

        function showProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // ƒê·ªçc file n·ªôi dung v·ªõi ExcelJS
        async function readExcelFile(file) {
            const workbook = new ExcelJS.Workbook();
            const arrayBuffer = await file.arrayBuffer();
            await workbook.xlsx.load(arrayBuffer);
            
            const noiDungData = {};
            
            // ƒê·ªçc d·ªØ li·ªáu t·ª´ m·ªói sheet trong file n·ªôi dung
            workbook.worksheets.forEach(sheet => {
                const sheetName = sheet.name;
                const data = {};
                
                // Duy·ªát qua t·ª´ng d√≤ng b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 2
                sheet.eachRow((row, rowNumber) => {
                    if (rowNumber >= 2) { // B·∫Øt ƒë·∫ßu t·ª´ d√≤ng 2
                        const tiet = row.getCell(2).value; // C·ªôt B
                        const tenBai = row.getCell(3).value; // C·ªôt C
                        
                        if (tiet !== null && tiet !== undefined && 
                            tenBai !== null && tenBai !== undefined) {
                            data[tiet] = String(tenBai);
                        }
                    }
                });
                
                noiDungData[sheetName] = data;
            });
            
            return noiDungData;
        }

        // ƒê·ªçc file l·ªãch b√°o gi·∫£ng v·ªõi ExcelJS ƒë·ªÉ gi·ªØ ƒë·ªãnh d·∫°ng
        async function readExcelFileWithFormat(file) {
            const workbook = new ExcelJS.Workbook();
            const arrayBuffer = await file.arrayBuffer();
            await workbook.xlsx.load(arrayBuffer);
            return workbook;
        }

        // X·ª≠ l√Ω d·ªØ li·ªáu theo logic Python
        async function processDataLikePython(noiDungData, lichBaoGiangWorkbook) {
            const classLastPeriod = {}; // L∆∞u s·ªë ti·∫øt cu·ªëi c√πng c·ªßa t·ª´ng l·ªõp
            
            // X·ª≠ l√Ω t·ª´ng sheet trong file l·ªãch b√°o gi·∫£ng
            lichBaoGiangWorkbook.worksheets.forEach(sheet => {
                const sheetName = sheet.name;
                
                // Duy·ªát qua t·ª´ng d√≤ng trong sheet b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 4
                sheet.eachRow((row, rowNumber) => {
                    if (rowNumber >= 4) { // B·∫Øt ƒë·∫ßu t·ª´ d√≤ng 4
                        const monHocCell = row.getCell(4); // C·ªôt D: M√¥n h·ªçc
                        const lopCell = row.getCell(5); // C·ªôt E: L·ªõp
                        const tietCell = row.getCell(6); // C·ªôt F: Ti·∫øt th·ª© theo PPCT
                        const baiCell = row.getCell(7); // C·ªôt G: T√™n b√†i gi·∫£ng
                        
                        // N·∫øu c√≥ d·ªØ li·ªáu l·ªõp (kh√¥ng ph·∫£i √¥ tr·ªëng)
                        if (lopCell.value !== null && lopCell.value !== undefined) {
                            const lop = String(lopCell.value).trim();
                            
                            // X√°c ƒë·ªãnh kh·ªëi l·ªõp t·ª´ t√™n l·ªõp (10, 11, 12)
                            const khoi = lop.substring(0, 2); // L·∫•y 2 k√Ω t·ª± ƒë·∫ßu ti√™n
                            if (!["10", "11", "12"].includes(khoi)) {
                                return; // B·ªè qua n·∫øu kh√¥ng ph·∫£i l·ªõp h·ª£p l·ªá
                            }

                            // Ki·ªÉm tra m√¥n h·ªçc trong c·ªôt D
                            let isLuyenTap = false;
                            if (monHocCell.value !== null && monHocCell.value !== undefined) {
                                const monHoc = String(monHocCell.value).trim();
                                // Ki·ªÉm tra 3 k√Ω t·ª± cu·ªëi c√≥ ph·∫£i l√† "***" kh√¥ng
                                if (monHoc.length >= 3 && monHoc.slice(-3) === "***") {
                                    isLuyenTap = true;
                                    // X√≥a "***" ·ªü cu·ªëi v√† c·∫≠p nh·∫≠t l·∫°i √¥
                                    const monHocSauKhiXoa = monHoc.slice(0, -3).trim();
                                    monHocCell.value = monHocSauKhiXoa;
                                }
                            }

                            if (isLuyenTap) {
                                // N·∫øu c√≥ "***" ·ªü cu·ªëi m√¥n h·ªçc
                                tietCell.value = "TC"; // C·ªôt F ƒëi·ªÅn "TC"
                                baiCell.value = "Luy·ªán t·∫≠p"; // C·ªôt G ƒëi·ªÅn "Luy·ªán t·∫≠p"
                            } else {
                                // X·ª≠ l√Ω b√¨nh th∆∞·ªùng
                                // TƒÉng s·ªë ti·∫øt cho t·ª´ng l·ªõp
                                if (!classLastPeriod[lop]) {
                                    classLastPeriod[lop] = 1;
                                } else {
                                    classLastPeriod[lop] += 1;
                                }
                                
                                // ƒêi·ªÅn s·ªë ti·∫øt v√†o c·ªôt F
                                const tietHienTai = classLastPeriod[lop];
                                tietCell.value = tietHienTai;
                                
                                // Tra c·ª©u t√™n b√†i h·ªçc trong sheet t∆∞∆°ng ·ª©ng v·ªõi kh·ªëi l·ªõp
                                let tenBai;
                                if (noiDungData[khoi] && noiDungData[khoi][tietHienTai]) {
                                    tenBai = noiDungData[khoi][tietHienTai];
                                } else {
                                    tenBai = "Kh√¥ng c√≥ d·ªØ li·ªáu";
                                }
                                
                                baiCell.value = tenBai;
                            }
                        }
                    }
                });
            });
        }

        // T·∫°o v√† t·∫£i file Excel v·ªõi ExcelJS
        async function downloadExcelFile(workbook, fileName) {
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.endsWith('.xlsx') ? fileName : fileName + '.xlsx';
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>