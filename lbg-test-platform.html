<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch B√°o Gi·∫£ng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 1.1em;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .file-input-label .icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .file-name {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-style: italic;
            color: #666;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .submit-btn .icon {
            margin-right: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
            text-align: center;
            display: none;
        }

        .status.processing {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì L·ªãch B√°o Gi·∫£ng</h1>
        
        <form id="excelForm">
            <div class="form-group">
                <label for="lichBaoGiang">üìÖ Ch·ªçn file L·ªãch B√°o Gi·∫£ng (.xlsx):</label>
                <div class="file-input-wrapper">
                    <input type="file" id="lichBaoGiang" class="file-input" accept=".xlsx,.xls" required>
                    <label for="lichBaoGiang" class="file-input-label">
                        <span class="icon">üìÅ</span>
                        Ch·ªçn file L·ªãch B√°o Gi·∫£ng
                    </label>
                </div>
                <div class="file-name" id="lichBaoGiangName">Ch∆∞a ch·ªçn file</div>
            </div>

            <div class="form-group">
                <label for="noiDung">üìö Ch·ªçn file N·ªôi Dung (.xlsx):</label>
                <div class="file-input-wrapper">
                    <input type="file" id="noiDung" class="file-input" accept=".xlsx,.xls" required>
                    <label for="noiDung" class="file-input-label">
                        <span class="icon">üìÅ</span>
                        Ch·ªçn file N·ªôi Dung
                    </label>
                </div>
                <div class="file-name" id="noiDungName">Ch∆∞a ch·ªçn file</div>
            </div>

            <div class="form-group">
                <label for="outputName">üíæ T√™n file xu·∫•t ra:</label>
                <input type="text" id="outputName" placeholder="Nh·∫≠p t√™n file (kh√¥ng c·∫ßn ƒëu√¥i .xlsx)" value="" required>
            </div>

            <div class="form-group">
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="icon">‚ö°</span>
                    X·ª≠ L√Ω v√† T·∫£i File
                </button>
            </div>
        </form>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status" id="status"></div>
    </div>

    <script>
        // X·ª≠ l√Ω hi·ªÉn th·ªã t√™n file
        document.getElementById('lichBaoGiang').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Ch∆∞a ch·ªçn file';
            document.getElementById('lichBaoGiangName').textContent = fileName;
        });

        document.getElementById('noiDung').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Ch∆∞a ch·ªçn file';
            document.getElementById('noiDungName').textContent = fileName;
        });

        // X·ª≠ l√Ω form submit
        document.getElementById('excelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const lichBaoGiangFile = document.getElementById('lichBaoGiang').files[0];
            const noiDungFile = document.getElementById('noiDung').files[0];
            const outputName = document.getElementById('outputName').value.trim();
            
            if (!lichBaoGiangFile || !noiDungFile || !outputName) {
                showStatus('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß c√°c file v√† nh·∫≠p t√™n file xu·∫•t ra!', 'error');
                return;
            }

            try {
                showStatus('ƒêang x·ª≠ l√Ω file...', 'processing');
                showProgress(0);
                
                // ƒê·ªçc file n·ªôi dung - s·ª≠ d·ª•ng c√°ch t∆∞∆°ng t·ª± tkb.html
                const noiDungData = await readNoiDungFile(noiDungFile);
                showProgress(30);
                
                // ƒê·ªçc file l·ªãch b√°o gi·∫£ng - s·ª≠ d·ª•ng c√°ch t∆∞∆°ng t·ª± tkb.html
                const lichBaoGiangWorkbook = await readExcelFile(lichBaoGiangFile);
                showProgress(60);
                
                // X·ª≠ l√Ω d·ªØ li·ªáu
                await processDataLikePython(noiDungData, lichBaoGiangWorkbook);
                showProgress(90);
                
                // T·∫°o v√† t·∫£i file
                await downloadExcelFile(lichBaoGiangWorkbook, outputName);
                showProgress(100);
                
                showStatus('‚úÖ X·ª≠ l√Ω ho√†n th√†nh! File ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng.', 'success');
                
            } catch (error) {
                console.error('L·ªói:', error);
                showStatus('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
            }
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'processing') {
                document.getElementById('progressBar').style.display = 'block';
            } else {
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
            }
        }

        function showProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // ƒê·ªçc file Excel - s·ª≠ d·ª•ng c√πng c√°ch v·ªõi tkb.html
        async function readExcelFile(file) {
            const workbook = new ExcelJS.Workbook();
            const arrayBuffer = await file.arrayBuffer();
            await workbook.xlsx.load(arrayBuffer);
            return workbook;
        }

        // ƒê·ªçc file n·ªôi dung - t·ªëi ∆∞u h√≥a theo c√°ch c·ªßa tkb.html
        async function readNoiDungFile(file) {
            const workbook = await readExcelFile(file);
            const noiDungData = {};
            
            // ƒê·ªçc d·ªØ li·ªáu t·ª´ m·ªói sheet trong file n·ªôi dung
            workbook.worksheets.forEach(sheet => {
                const sheetName = sheet.name;
                const data = {};
                
                console.log(`ƒêang ƒë·ªçc sheet: ${sheetName}`);
                
                // Duy·ªát qua t·ª´ng d√≤ng b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 2
                sheet.eachRow((row, rowNumber) => {
                    if (rowNumber >= 2) { // B·∫Øt ƒë·∫ßu t·ª´ d√≤ng 2
                        const tietCell = row.getCell(2); // C·ªôt B
                        const tenBaiCell = row.getCell(3); // C·ªôt C
                        
                        const tiet = tietCell.value;
                        const tenBai = tenBaiCell.value;
                        
                        if (tiet !== null && tiet !== undefined && 
                            tenBai !== null && tenBai !== undefined) {
                            // Chuy·ªÉn ƒë·ªïi gi√° tr·ªã th√†nh string ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n
                            const tietStr = String(tiet).trim();
                            const tenBaiStr = String(tenBai).trim();
                            
                            if (tietStr && tenBaiStr) {
                                data[tietStr] = tenBaiStr;
                                console.log(`Sheet ${sheetName} - Ti·∫øt ${tietStr}: ${tenBaiStr}`);
                            }
                        }
                    }
                });
                
                noiDungData[sheetName] = data;
                console.log(`ƒê√£ ƒë·ªçc ${Object.keys(data).length} ti·∫øt t·ª´ sheet ${sheetName}`);
            });
            
            return noiDungData;
        }

        // X·ª≠ l√Ω d·ªØ li·ªáu theo logic Python - c·∫£i ti·∫øn v·ªõi error handling t·ªët h∆°n
        async function processDataLikePython(noiDungData, lichBaoGiangWorkbook) {
            const classLastPeriod = {}; // L∆∞u s·ªë ti·∫øt cu·ªëi c√πng c·ªßa t·ª´ng l·ªõp
            let processedRows = 0;
            
            console.log('B·∫Øt ƒë·∫ßu x·ª≠ l√Ω d·ªØ li·ªáu...');
            console.log('D·ªØ li·ªáu n·ªôi dung:', noiDungData);
            
            // X·ª≠ l√Ω t·ª´ng sheet trong file l·ªãch b√°o gi·∫£ng
            lichBaoGiangWorkbook.worksheets.forEach((sheet, sheetIndex) => {
                const sheetName = sheet.name;
                console.log(`ƒêang x·ª≠ l√Ω sheet: ${sheetName}`);
                
                // Duy·ªát qua t·ª´ng d√≤ng trong sheet b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 4
                sheet.eachRow((row, rowNumber) => {
                    if (rowNumber >= 4) { // B·∫Øt ƒë·∫ßu t·ª´ d√≤ng 4
                        const monHocCell = row.getCell(4); // C·ªôt D: M√¥n h·ªçc
                        const lopCell = row.getCell(5); // C·ªôt E: L·ªõp
                        const tietCell = row.getCell(6); // C·ªôt F: Ti·∫øt th·ª© theo PPCT
                        const baiCell = row.getCell(7); // C·ªôt G: T√™n b√†i gi·∫£ng
                        
                        // N·∫øu c√≥ d·ªØ li·ªáu l·ªõp (kh√¥ng ph·∫£i √¥ tr·ªëng)
                        if (lopCell.value !== null && lopCell.value !== undefined) {
                            const lopValue = String(lopCell.value).trim();
                            
                            if (lopValue) {
                                // X√°c ƒë·ªãnh kh·ªëi l·ªõp t·ª´ t√™n l·ªõp (10, 11, 12)
                                const khoi = lopValue.substring(0, 2); // L·∫•y 2 k√Ω t·ª± ƒë·∫ßu ti√™n
                                
                                if (["10", "11", "12"].includes(khoi)) {
                                    // Ki·ªÉm tra m√¥n h·ªçc trong c·ªôt D
                                    let isLuyenTap = false;
                                    if (monHocCell.value !== null && monHocCell.value !== undefined) {
                                        const monHoc = String(monHocCell.value).trim();
                                        // Ki·ªÉm tra 3 k√Ω t·ª± cu·ªëi c√≥ ph·∫£i l√† "***" kh√¥ng
                                        if (monHoc.length >= 3 && monHoc.slice(-3) === "***") {
                                            isLuyenTap = true;
                                            // X√≥a "***" ·ªü cu·ªëi v√† c·∫≠p nh·∫≠t l·∫°i √¥
                                            const monHocSauKhiXoa = monHoc.slice(0, -3).trim();
                                            monHocCell.value = monHocSauKhiXoa;
                                            console.log(`X·ª≠ l√Ω luy·ªán t·∫≠p cho l·ªõp ${lopValue}`);
                                        }
                                    }

                                    if (isLuyenTap) {
                                        // N·∫øu c√≥ "***" ·ªü cu·ªëi m√¥n h·ªçc
                                        tietCell.value = "TC"; // C·ªôt F ƒëi·ªÅn "TC"
                                        baiCell.value = "Luy·ªán t·∫≠p"; // C·ªôt G ƒëi·ªÅn "Luy·ªán t·∫≠p"
                                        console.log(`L·ªõp ${lopValue}: Luy·ªán t·∫≠p`);
                                    } else {
                                        // X·ª≠ l√Ω b√¨nh th∆∞·ªùng
                                        // TƒÉng s·ªë ti·∫øt cho t·ª´ng l·ªõp
                                        if (!classLastPeriod[lopValue]) {
                                            classLastPeriod[lopValue] = 1;
                                        } else {
                                            classLastPeriod[lopValue] += 1;
                                        }
                                        
                                        // ƒêi·ªÅn s·ªë ti·∫øt v√†o c·ªôt F
                                        const tietHienTai = classLastPeriod[lopValue];
                                        tietCell.value = tietHienTai;
                                        
                                        // Tra c·ª©u t√™n b√†i h·ªçc trong sheet t∆∞∆°ng ·ª©ng v·ªõi kh·ªëi l·ªõp
                                        let tenBai = "Kh√¥ng c√≥ d·ªØ li·ªáu";
                                        
                                        if (noiDungData[khoi] && noiDungData[khoi][String(tietHienTai)]) {
                                            tenBai = noiDungData[khoi][String(tietHienTai)];
                                        }
                                        
                                        baiCell.value = tenBai;
                                        console.log(`L·ªõp ${lopValue} - Ti·∫øt ${tietHienTai}: ${tenBai}`);
                                        processedRows++;
                                    }
                                }
                            }
                        }
                    }
                });
            });
            
            console.log(`ƒê√£ x·ª≠ l√Ω ${processedRows} d√≤ng d·ªØ li·ªáu`);
            console.log('Tr·∫°ng th√°i l·ªõp:', classLastPeriod);
        }

        // T·∫°o v√† t·∫£i file Excel - s·ª≠ d·ª•ng c√πng c√°ch v·ªõi tkb.html
        async function downloadExcelFile(workbook, fileName) {
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.endsWith('.xlsx') ? fileName : fileName + '.xlsx';
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>